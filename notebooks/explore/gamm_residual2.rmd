
# SA GAMM
Apply GAMM to all years of SA data including weather covariates

```{r setup, include=F}
knitr::opts_chunk$set(root.dir="~/tesla-stlf")
knitr::opts_knit$set(root.dir="~/tesla-stlf")
require(mgcv)
rmse <- function(true, pred) {sqrt(mean((true - pred)^2))}
mape <- function(true, pred) {mean((abs(true - pred) / true))}
mae <- function(true, pred) {mean(abs(true - pred))}
all_metrics <- function(x, true, pred) {do.call(x, list(true=true, pred=pred))}
print_metrics <- function(true, pred, title) {
    cat(title, fill=T)
    cat("MAPE:", paste0(round(mape(true, pred), 4)*100, '%'),
        "MAE:", mae(true, pred),
        "RMSE:", rmse(true, pred), fill=T)
}
set.seed(12345)
```

Quick preprocess of data.

```{r}
source("notebooks/intra_day/Functions.R")

df <- read.csv("data/sa/merged.csv")

holi.df <- read.csv("data/australian-public-holidays-combined-2021-2024.csv")
holidates <- as.POSIXct(as.character(holi.df$Date), format="%Y%m%d", tz="Australia/South")
holidays <- as.POSIXct(as.vector(sapply(holidates, function(x) seq(x, by=1800, length.out=48))), tz="Australia/South")

# make year and Time from datetime
df$ACDT <- as.POSIXct(paste(df$datetime, "+1000"), format="%F %T %z", tz="Australia/South")
df$ACST <- df$ACDT - ((as.POSIXlt(df$ACDT)$isdst > 0) * (60 * 60))

df$ACST.lt <- as.POSIXlt(df$ACST)
df$ACDT.lt <- as.POSIXlt(df$ACDT)

df <- subset(df, df$ACDT.lt$year+1900 > 2021, -pv_est)
df$rainmm[is.na(df$rainmm)] <- 0
df$cloud8[is.na(df$cloud8)] <- 0

# time normalised to [0, 1) via proportion of minutes per day
df$Time <- (df$ACST.lt$hour*60 + df$ACST.lt$min) / (60*24)
df$DSTTime <- df$Time + ((df$ACDT.lt$isdst!=0) / 24)
df$Year <- (df$ACST.lt$yday + df$Time) / 365
df$Week <- (df$ACST.lt$wday + df$Time) / 7
df$WtdTemp <- wtdtemp(df$DSTTime, df$tempc)

df$weekday <- df$ACDT.lt$wday
df$holiday <- df$ACDT %in% holidays

head(df)
```

Fit GAMM with intra-day covariates.

```{r}
df.2022 <- df[df$ACDT.lt$year+1900 == 2022,]
df.2023 <- df[df$ACDT.lt$year+1900 == 2023,]
true.2022 <- df.2022$net_load
true.2023 <- df.2023$net_load

gam.form <- net_load ~ s(DSTTime, bs = "cc") + s(WtdTemp, bs="tp") + s(Year, bs = "tp")

gam.2022 <- mgcv::gamm(gam.form, data=df.2022)
summary(gam.2022$gam)
```

Model residuals from GAM with random forest.

```{r}
pred.2022 <- predict(gam.2022$gam, df.2022)
pred.2023 <- predict(gam.2022$gam, df.2023)

df.2022$residual <- true.2022 - pred.2022
df.2023$residual <- true.2023 - pred.2023

res.form <- residual ~ radkjm2 + tempc + humid + cloud8 + rainmm + windk + wdir + weekday + holiday
rf.form <- net_load ~ DSTTime + WtdTemp + Year + radkjm2 + tempc + humid + cloud8 + rainmm + windk + wdir + weekday + holiday

rf.2022 <- randomForest::randomForest(rf.form, data=df.2022, importance=T)
rf.res.2022 <- randomForest::randomForest(res.form, data=df.2022, importance=T)
rf.res.2022
```

```{r}
rf.res.2022$importance[rev(order(rf.res.2022$importance[,'%IncMSE'])),]
```


Compute train/test aggregate metrics from GAM+RF

```{r}
res.pred.2022 <- predict(rf.res.2022, df.2022)
res.pred.2023 <- predict(rf.res.2022, df.2023)
rf.pred.2022 <- predict(rf.2022, df.2022)
rf.pred.2023 <- predict(rf.2022, df.2023)

print_metrics(true.2022, pred.2022, "GAM train")
print_metrics(true.2023, pred.2023, "GAM test")
print_metrics(true.2022, pred.2022 + res.pred.2022, "GAM+RF train")
print_metrics(true.2023, pred.2023 + res.pred.2023, "GAM+RF test")
print_metrics(true.2022, rf.pred.2022, "RF train")
print_metrics(true.2023, rf.pred.2023, "RF test")
```
SA interpolated:

GAM train
RMSE: 215.9121 MAPE: 0.159427 MAE: 160.8828
GAM test
RMSE: 288.9623 MAPE: 0.2561387 MAE: 217.3056
GAM+RF train
RMSE: 51.8777 MAPE: 0.03204601 MAE: 37.12639
GAM+RF test
RMSE: 200.7446 MAPE: 0.1530442 MAE: 148.073

SA original (nodesize 5):

GAM train
RMSE: 215.5052 MAPE: 0.1585704 MAE: 160.3554
GAM test
RMSE: 291.8159 MAPE: 0.2561496 MAE: 219.1722
GAM+RF train
RMSE: 65.69241 MAPE: 0.04211303 MAE: 48.05288
GAM+RF test
RMSE: 206.4527 MAPE: 0.1576982 MAE: 151.4751

SA original (nodesize 1):

GAM train
RMSE: 215.5052 MAPE: 0.1585704 MAE: 160.3554
GAM test
RMSE: 291.8159 MAPE: 0.2561496 MAE: 219.1722
GAM+RF train
RMSE: 52.26313 MAPE: 0.03379186 MAE: 38.5281
GAM+RF test
RMSE: 205.6147 MAPE: 0.1566431 MAE: 151.1194

