---
title: "intra_day_preprocess"
output: html_document
date: "2023-04-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
data_path <- "../data/merged_interpolated.csv"
df <- read.csv(data_path)
head(df)
```

Select columns relevant to the intra-day models

```{r}
df2 <- df[,c('datetime', 'tempc', 'net_load')]
```

Australian Central Standard Time assumed to be the read-in default - consider as UTC to postpone DST adjustments.

```{r}
df2$acst <- as.POSIXct(df2$datetime, format="%F %T", tz="UTC")
head(df2)
```

Subset to just one year with the relevant variables for intra-day models.

```{r}
date_range <- as.POSIXct(c('2021-02-03', '2022-02-02'), tz="UTC")
df3 <- df2[date_range[1] <= df2$acst & 
             df2$acst <= date_range[2],]
head(df3)
```

Create DST adjusted timestamp via correct timezone and offset.

```{r}
df3$acdt <- as.POSIXct(paste(df3$datetime, "+1030"), format="%F %T %z", tz="Australia/South")
head(df3)
```

Demonstrate standard / daylight time differences.

```{r}
head(df3[as.character(df3$acst) != as.character(df3$acdt),])
```

Create standardised Time variable to fit intra-day Model 1 requirements.

```{r}
dt.lt <- as.POSIXlt(df3$acst)
# time normalised to [0, 1) via proportion of 1440 minutes per day
df3$Time <- (dt.lt$hour*60 + dt.lt$min) / 1440
summary(df3$Time)
```

Additionally require DST adjusted version of standardised Time field.

```{r}
dst.lt <- as.POSIXlt(df3$acdt)
df3$DST <- ((dst.lt$hour*60 + dst.lt$min) + 60*(dst.lt$isdst!=0)) / 1440
summary(df3$DST)
```

Max standardised DST should be 2 observations ahead, out of 48.

```{r}
c(max(df3$DST) - max(df3$Time), 2 / 48)
```

Create standardised time of the Year with range [0,1), 0 being first observation of the year and 1 being just after the final observation (by standard time). Should be calculated before weekends are removed. Resulting steps should match either 1/n_obs or a post-weekend step of 48*2/n_obs

```{r}
df3$year <- (order(dst.lt) - 1) / (365 * 48)
df4 <- df3[dst.lt$wday %in% 1:5,]
print(unique(round(diff(df4$year), 2)))
round(c(1, 48*2) / (365*48), 2)
```

Subset to just those variables necessary for modeling.

```{r}
df5 <- cbind(df4[,c('net_load', 'tempc', 'Time', 'DST', 'year')])
head(df5)
```

Add time-weighted temperature.

```{r}
source("../Functions.R")
df5$WtdTemp <- wtdtemp(df5$DST, df5$tempc)
```

Write to file

```{r}
write.csv(df5, "../data/intra_day2022.csv", row.names=F)
```

